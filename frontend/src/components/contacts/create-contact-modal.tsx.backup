'use client'

import { useState } from 'react'
import { Dialog } from '@headlessui/react'
import { XMarkIcon } from '@heroicons/react/24/outline'
import { ArrowTopRightOnSquareIcon } from '@heroicons/react/24/outline'
import { useMutation, useQueryClient, useQuery } from '@tanstack/react-query'
import { cn } from '@/lib/utils'

interface CreateContactModalProps {
  isOpen: boolean
  onClose: () => void
  onSuccess: () => void
}

interface ContactFormData {
  firstName: string
  lastName: string
  title?: string
  department?: string
  companyId?: string
  emailAddresses: Array<{
    email: string
    isPrimary: boolean
    typeId?: string
  }>
  phoneNumbers: Array<{
    number: string
    extension?: string
    isPrimary: boolean
    typeId?: string
  }>
  addresses: Array<{
    street1?: string
    street2?: string
    city?: string
    state?: string
    postalCode?: string
    country?: string
    isPrimary: boolean
    typeId?: string
  }>
  socialMedia: Array<{
    username?: string
    url?: string
    isPrimary: boolean
    typeId?: string
  }>
  emailOptIn: boolean
  smsOptIn: boolean
  callOptIn: boolean
  originalSource?: string
}

// Temporary API client
const apiClient = {
  createContact: async (contactData: any) => {
    const token = localStorage.getItem('token')
    const response = await fetch('http://localhost:8089/api/contacts', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(contactData),
    })

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      throw new Error(errorData.error || 'Failed to create contact')
    }

    return response.json()
  },
  getCompanies: async () => {
    const token = localStorage.getItem('token')
    const response = await fetch('http://localhost:8089/api/companies?limit=100', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    })

    if (!response.ok) {
      throw new Error('Failed to fetch companies')
    }

    return response.json()
  },
  getPhoneNumberTypes: async () => {
    const token = localStorage.getItem('token')
    const response = await fetch('http://localhost:8089/api/lookups/phone-number-types', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    })

    if (!response.ok) {
      throw new Error('Failed to fetch phone number types')
    }

    return response.json()
  },
  getEmailAddressTypes: async () => {
    const token = localStorage.getItem('token')
    const response = await fetch('http://localhost:8089/api/lookups/email-address-types', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    })

    if (!response.ok) {
      throw new Error('Failed to fetch email address types')
    }

    return response.json()
  },
  getAddressTypes: async () => {
    const token = localStorage.getItem('token')
    const response = await fetch('http://localhost:8089/api/lookups/address-types', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    })

    if (!response.ok) {
      throw new Error('Failed to fetch address types')
    }

    return response.json()
  },
  getSocialMediaTypes: async () => {
    const token = localStorage.getItem('token')
    const response = await fetch('http://localhost:8089/api/lookups/social-media-types', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    })

    if (!response.ok) {
      throw new Error('Failed to fetch social media types')
    }

    return response.json()
  }
}

export function CreateContactModal({ isOpen, onClose, onSuccess }: CreateContactModalProps) {
  const [formData, setFormData] = useState<ContactFormData>({
    firstName: '',
    lastName: '',
    title: '',
    department: '',
    companyId: '',
    emailAddresses: [{ email: '', isPrimary: true }],
    phoneNumbers: [{ number: '', isPrimary: true }],
    addresses: [{ isPrimary: true }],
    socialMedia: [{ isPrimary: true }],
    emailOptIn: true,
    smsOptIn: false,
    callOptIn: true,
    originalSource: ''
  })

  const [errors, setErrors] = useState<Record<string, string>>({})
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [createAndAddAnother, setCreateAndAddAnother] = useState(false)

  const queryClient = useQueryClient()

  // Fetch lookup data
  const { data: companiesData } = useQuery({
    queryKey: ['companies'],
    queryFn: () => apiClient.getCompanies(),
    enabled: isOpen,
  })

  const { data: phoneTypesData } = useQuery({
    queryKey: ['phoneNumberTypes'],
    queryFn: () => apiClient.getPhoneNumberTypes(),
    enabled: isOpen,
  })

  const { data: emailTypesData } = useQuery({
    queryKey: ['emailAddressTypes'],
    queryFn: () => apiClient.getEmailAddressTypes(),
    enabled: isOpen,
  })

  const { data: addressTypesData } = useQuery({
    queryKey: ['addressTypes'],
    queryFn: () => apiClient.getAddressTypes(),
    enabled: isOpen,
  })

  const { data: socialMediaTypesData } = useQuery({
    queryKey: ['socialMediaTypes'],
    queryFn: () => apiClient.getSocialMediaTypes(),
    enabled: isOpen,
  })

  const createContactMutation = useMutation({
    mutationFn: apiClient.createContact,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['contacts'] })
      if (createAndAddAnother) {
        // Reset form for another contact
        setFormData({
          firstName: '',
          lastName: '',
          title: '',
          department: '',
          companyId: '',
          emailAddresses: [{ email: '', isPrimary: true }],
          phoneNumbers: [{ number: '', isPrimary: true }],
          addresses: [{ isPrimary: true }],
          socialMedia: [{ isPrimary: true }],
          emailOptIn: true,
          smsOptIn: false,
          callOptIn: true,
          originalSource: ''
        })
        setErrors({})
      } else {
        onSuccess()
      }
    },
    onError: (error: any) => {
      console.error('Failed to create contact:', error)
      setErrors({ submit: error.message || 'Failed to create contact' })
    },
    onSettled: () => {
      setIsSubmitting(false)
    }
  })

  const validateForm = (): boolean => {
    const newErrors: Record<string, string> = {}

    if (!formData.firstName.trim()) {
      newErrors.firstName = 'First name is required'
    }

    if (!formData.lastName.trim()) {
      newErrors.lastName = 'Last name is required'
    }

    if (formData.emailAddresses.length > 0 && formData.emailAddresses[0].email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      if (!emailRegex.test(formData.emailAddresses[0].email)) {
        newErrors.email = 'Please enter a valid email address'
      }
    }

    if (formData.phoneNumbers.length > 0 && formData.phoneNumbers[0].number) {
      const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/
      const cleanPhone = formData.phoneNumbers[0].number.replace(/[\s\-\(\)]/g, '')
      if (!phoneRegex.test(cleanPhone)) {
        newErrors.phone = 'Please enter a valid phone number'
      }
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    if (!validateForm()) {
      return
    }

    setIsSubmitting(true)
    setErrors({})

    try {
      // Prepare contact data for API
      const contactData = {
        firstName: formData.firstName,
        lastName: formData.lastName,
        title: formData.title || undefined,
        department: formData.department || undefined,
        companyId: formData.companyId || undefined,
        originalSource: formData.originalSource || undefined,
        emailOptIn: formData.emailOptIn,
        smsOptIn: formData.smsOptIn,
        callOptIn: formData.callOptIn,
        // Add contact information arrays
        emailAddresses: formData.emailAddresses.filter(e => e.email.trim()),
        phoneNumbers: formData.phoneNumbers.filter(p => p.number.trim()),
        addresses: formData.addresses.filter(a => a.street1?.trim() || a.city?.trim()),
        socialMedia: formData.socialMedia.filter(s => s.username?.trim() || s.url?.trim())
      }

      await createContactMutation.mutateAsync(contactData)
    } catch (error) {
      console.error('Submit error:', error)
    }
  }

  const handleInputChange = (field: keyof ContactFormData, value: any) => {
    setFormData(prev => ({
      ...prev,
      [field]: value
    }))
    
    // Clear field-specific error when user starts typing
    if (errors[field]) {
      setErrors(prev => ({
        ...prev,
        [field]: ''
      }))
    }
  }

  const handleArrayChange = (arrayName: keyof Pick<ContactFormData, 'emailAddresses' | 'phoneNumbers' | 'addresses' | 'socialMedia'>, index: number, field: string, value: any) => {
    setFormData(prev => ({
      ...prev,
      [arrayName]: prev[arrayName].map((item, i) => 
        i === index ? { ...item, [field]: value } : item
      )
    }))
  }

  }
  const companies = companiesData?.data?.data || []
  const phoneTypes = phoneTypesData?.data?.data || []
  const emailTypes = emailTypesData?.data?.data || []
  const addressTypes = addressTypesData?.data?.data || []
  const socialMediaTypes = socialMediaTypesData?.data?.data || []

  return (
    <Dialog open={isOpen} onClose={onClose} className="relative z-50">
      <div className="fixed inset-0 bg-black/30" aria-hidden="true" />
      
      <div className="fixed inset-0 flex items-center justify-center p-4">
        <Dialog.Panel className="mx-auto max-w-2xl w-full bg-white rounded-lg shadow-xl">
          {/* Header */}
          <div className="bg-gradient-to-r from-teal-500 to-green-500 px-6 py-4 rounded-t-lg flex items-center justify-between">
            <Dialog.Title className="text-lg font-semibold text-white">
              Create Contact
            </Dialog.Title>
            <div className="flex items-center space-x-4">
              <button
                type="button"
                className="text-white/80 hover:text-white text-sm flex items-center"
              >
                <ArrowTopRightOnSquareIcon className="h-4 w-4 mr-1" />
                Edit this form
              </button>
              <button
                type="button"
                onClick={onClose}
                className="text-white/80 hover:text-white"
              >
                <XMarkIcon className="h-5 w-5" />
              </button>
            </div>
          </div>

          {/* Form */}
          <form onSubmit={handleSubmit} className="p-6 max-h-[70vh] overflow-y-auto">
            <div className="space-y-6">
              {/* Email */}
              <div>
                <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-2">
                  Email
                </label>
                <input
                  type="email"
                  id="email"
                  value={formData.emailAddresses[0]?.email || ''}
                  onChange={(e) => handleArrayChange('emailAddresses', 0, 'email', e.target.value)}
                  className={cn(
                    "w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500",
                    errors.email ? "border-red-300" : "border-gray-300"
                  )}
                  placeholder="brians@gmail.com"
                />
                {errors.email && (
                  <p className="mt-1 text-sm text-red-600">{errors.email}</p>
                )}
              </div>

              {/* First Name */}
              <div>
                <label htmlFor="firstName" className="block text-sm font-medium text-gray-700 mb-2">
                  First name
                </label>
                <input
                  type="text"
                  id="firstName"
                  value={formData.firstName}
                  onChange={(e) => handleInputChange('firstName', e.target.value)}
                  className={cn(
                    "w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500",
                    errors.firstName ? "border-red-300" : "border-gray-300"
                  )}
                  placeholder="Brian"
                />
                {errors.firstName && (
                  <p className="mt-1 text-sm text-red-600">{errors.firstName}</p>
                )}
              </div>

              {/* Last Name */}
              <div>
                <label htmlFor="lastName" className="block text-sm font-medium text-gray-700 mb-2">
                  Last name
                </label>
                <input
                  type="text"
                  id="lastName"
                  value={formData.lastName}
                  onChange={(e) => handleInputChange('lastName', e.target.value)}
                  className={cn(
                    "w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500",
                    errors.lastName ? "border-red-300" : "border-gray-300"
                  )}
                  placeholder="Stevens"
                />
                {errors.lastName && (
                  <p className="mt-1 text-sm text-red-600">{errors.lastName}</p>
                )}
              </div>

              {/* Contact Owner */}
              <div>
                <label htmlFor="contactOwner" className="block text-sm font-medium text-gray-700 mb-2">
                  Contact owner
                </label>
                <select
                  id="contactOwner"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                >
                  <option value="">Select contact owner</option>
                  <option value="theodore-tse">Theodore Tse</option>
                </select>
              </div>

              {/* Job Title */}
              <div>
                <label htmlFor="title" className="block text-sm font-medium text-gray-700 mb-2">
                  Job title
                </label>
                <input
                  type="text"
                  id="title"
                  value={formData.title}
                  onChange={(e) => handleInputChange('title', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                  placeholder="Engineer"
                />
              </div>

              {/* Phone Number */}
              <div>
                <label htmlFor="phone" className="block text-sm font-medium text-gray-700 mb-2">
                  Phone number
                </label>
                <input
                  type="tel"
                  id="phone"
                  value={formData.phoneNumbers[0]?.number || ''}
                  onChange={(e) => handleArrayChange('phoneNumbers', 0, 'number', e.target.value)}
                  className={cn(
                    "w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500",
                    errors.phone ? "border-red-300" : "border-gray-300"
                  )}
                  placeholder="+1 (416) 778-6543"
                />
                {errors.phone && (
                  <p className="mt-1 text-sm text-red-600">{errors.phone}</p>
                )}
              </div>

              {/* Lifecycle Stage */}
              <div>
                <label htmlFor="lifecycleStage" className="block text-sm font-medium text-gray-700 mb-2">
                  Lifecycle stage
                </label>
                <select
                  id="lifecycleStage"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                >
                  <option value="">Select lifecycle stage</option>
                  <option value="lead">Lead</option>
                  <option value="contact">Contact</option>
                  <option value="customer">Customer</option>
                  <option value="prospect">Prospect</option>
                </select>
              </div>

              {/* Lead Status */}
              <div>
                <label htmlFor="leadStatus" className="block text-sm font-medium text-gray-700 mb-2">
                  Lead status
                </label>
                <select
                  id="leadStatus"
                  className="w-full px-3 py-2 border border-teal-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-teal-50"
                >
                  <option value="">Select lead status</option>
                  <option value="new">New</option>
                  <option value="contacted">Contacted</option>
                  <option value="qualified">Qualified</option>
                  <option value="unqualified">Unqualified</option>
                </select>
              </div>

              {/* Company */}
              <div>
                <label htmlFor="company" className="block text-sm font-medium text-gray-700 mb-2">
                  Company
                </label>
                <select
                  id="company"
                  value={formData.companyId}
                  onChange={(e) => handleInputChange('companyId', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                >
                  <option value="">Select company</option>
                  {companies.map((company: any) => (
                    <option key={company.id} value={company.id}>
                      {company.name}
                    </option>
                  ))}
                </select>
              </div>

              {/* Communication Preferences */}
              <div className="space-y-3">
                <h4 className="text-sm font-medium text-gray-700">Communication Preferences</h4>
                <div className="space-y-2">
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.emailOptIn}
                      onChange={(e) => handleInputChange('emailOptIn', e.target.checked)}
                      className="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"
                    />
                    <span className="ml-2 text-sm text-gray-700">Email opt-in</span>
                  </label>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.smsOptIn}
                      onChange={(e) => handleInputChange('smsOptIn', e.target.checked)}
                      className="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"
                    />
                    <span className="ml-2 text-sm text-gray-700">SMS opt-in</span>
                  </label>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.callOptIn}
                      onChange={(e) => handleInputChange('callOptIn', e.target.checked)}
                      className="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"
                    />
                    <span className="ml-2 text-sm text-gray-700">Call opt-in</span>
                  </label>
                </div>
              </div>

              {/* Submit Error */}
              {errors.submit && (
                <div className="text-red-600 text-sm bg-red-50 p-3 rounded-md">
                  {errors.submit}
                </div>
              )}
            </div>
          </form>

          {/* Footer */}
          <div className="px-6 py-4 bg-gray-50 rounded-b-lg flex items-center justify-between">
            <div className="flex space-x-3">
              <button
                type="button"
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isSubmitting ? 'Creating...' : 'Create'}
              </button>
              <button
                type="button"
                onClick={() => {
                  setCreateAndAddAnother(true)
                  handleSubmit(new Event('submit') as any)
                }}
                disabled={isSubmitting}
                className="border border-orange-500 text-orange-500 px-4 py-2 rounded-md hover:bg-orange-50 focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Create and add another
              </button>
              <button
                type="button"
                onClick={onClose}
                className="border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
              >
                Cancel
              </button>
            </div>
          </div>
        </Dialog.Panel>
      </div>
    </Dialog>
  )
}
